.PHONY: build clean install doc toto distant chord

.DEFAULT: build

USE_OCAMLFIND = true

OCAMLPACKS[] =
	extlib
	cryptokit
	unix
	str

NATIVE_ENABLED = true
BYTE_ENABLED = false

#
# Various options
#
OCAMLFLAGS    += -g -warn-error A
# OCAMLCFLAGS   +=
# OCAMLOPTFLAGS +=
# OCAML_LINK_FLAGS +=
# OCAML_BYTE_LINK_FLAGS +=
# OCAML_NATIVE_LINK_FLAGS +=

src[]=
	read
	datamodel
	helpers
	write_index
	write_song

prog = $(OCamlProgram song-to-html,$(src))

build : $(prefix)/bin/song-to-html

mkdir -p $(prefix)/bin

$(prefix)/bin/song-to-html : song-to-html
	cp $< $@


src_chord[]=
	make_chord_svg
	chord

make_chord = $(OCamlProgram make-chord,$(src_chord))

letters[]=
	C
	D
	D-sharp
	E
	F
	F-sharp
	G
	G-sharp
	A
	A-sharp
	B

chords[]=
	$(addsuffix -e-form,$(letters)) 
	$(addsuffix 7-e-form,$(letters)) 
	$(addsuffix m-e-form,$(letters)) 
	$(addsuffix m7-e-form,$(letters)) 
	$(addsuffix 7M-e-form,$(letters)) 
	$(addsuffix -c-form,$(letters))

svg_chords=$(addsuffix .svg,$(chords))

$(svg_chords) : $(make_chord)
	./make-chord 

prefix=$(dir $(prefix))
mkdir -p $(prefix)/png

foreach(f,$(chords))
	$(prefix)/png/$f.png : $f.svg
		inkscape --export-png $@ --file $<
	export .RULE

chord : $(addprefix $(prefix)/png/,$(addsuffix .png,$(chords)))
