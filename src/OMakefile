.PHONY: build clean install doc toto distant chords check bin 

.DEFAULT: build

USE_OCAMLFIND = true

OCAMLPACKS[] =
	extlib
	cryptokit
	unix
	str

NATIVE_ENABLED = true
BYTE_ENABLED = false

#
# Various options
#
OCAMLFLAGS    += -g -warn-error A
# OCAMLCFLAGS   +=
# OCAMLOPTFLAGS +=
# OCAML_LINK_FLAGS +=
# OCAML_BYTE_LINK_FLAGS +=
# OCAML_NATIVE_LINK_FLAGS +=

src[]=
	read
	datamodel
	helpers
	write_index
	write_song
	write_pdf_song
	chord

src_chord[]=
	chord
	make_chord_svg

prog = $(OCamlProgram song-to-html,$(src))

prefix=$(dir $(prefix))
pngdir=$(dir $(prefix)/png)

build : $(prefix)/bin/song-to-html

mkdir -p tmp
mkdir -p $(prefix)/bin
mkdir -p $(pngdir)

$(prefix)/bin/song-to-html : song-to-html
	cp $< $@

make_chord = $(OCamlProgram make-chord,$(src_chord))

chord_list : $(make_chord)
	./make-chord --prefix $(prefix) --show-targets > $@

bin : $(make_chord) $(prog)

png_digest.txt : $(make_chord) 
	./make-chord --prefix $(prefix)


build : png_digest.txt

make_show =
	png_files=$(set $(ls $(pngdir)))
	ret=$(EMPTY)
	foreach(l,$(png_files))
		ret=$(concat $(EMPTY),$(ret) $"$(basename $l) $(digest $l)
")
		export
	value $(ret)

check : $(make_chord)
	section
		v1=$(make_show)
		v2=$(cat png_digest.pristine.txt)
		if $(not $(equal $"$(v1)",$"$(v2)"))
			println($"v1 and v2 are different")
			./make-chord --prefix $(prefix)
		else
			println($"v1 and v2 are the same")

		println($"done")


#.SCANNER: png_digest.txt : $(make_chord) :value: $(digest-in-path-optional $(prefix)/png , $&)

#$(png_chords) : $(make_chord)
#	./make-chord $(prefix)

#chord : $(addprefix $(prefix)/png/,$(addsuffix .png,$(chords)))

clean :
	rm -rf install
