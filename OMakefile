.PHONY: build clean install doc toto

.DEFAULT: build

srcdir = $(absname $(dir $(CWD)))

if $(not $(defined prefix))
	prefix = $(srcdir)/install
	export

println($"prefix is : $(prefix)")

USE_OCAMLFIND = true

OCAMLPACKS[] =
	extlib
	cryptokit
	unix
	str

NATIVE_ENABLED = true
BYTE_ENABLED = false

#
# Various options
#
OCAMLFLAGS    += -g -warn-error all
# OCAMLCFLAGS   +=
# OCAMLOPTFLAGS +=
# OCAML_LINK_FLAGS +=
# OCAML_BYTE_LINK_FLAGS +=
# OCAML_NATIVE_LINK_FLAGS +=

src[]=
	read

prog = $(OCamlProgram song-to-html,$(src))

build : $(prefix)/bin/song-to-html

mkdir -p $(prefix)/bin

$(prefix)/bin/song-to-html : song-to-html
	cp $< $@




println($"scrdir : $(srcdir)")


songs=$(glob songs/*.song)
println($"songs : $(songs)")

targets=$(removeprefix songs/,$(songs))
targets=$(addprefix $(srcdir)/,$(targets))
println($"targets : $(targets)")

build : $(prog) $(songs)
	./song-to-html $(srcdir)/songs $(prefix)



css[]=
	song.css
	song-print.css

foreach(f,$(css))
	build : $(prefix)/$f

	$(prefix)/$f : css/$f
		cp $< $@

	export .RULE

clean :
	rm $(filter-proper-targets $(ls R, .))